# February 16 - Demultiplexing and Denoising Data using DADA2. Data is also filtered out by taxa and features.

# Importing filtered manifest into project 2 folder on team server and demultiplexing data 
qiime tools import \
  --type "SampleData[SequencesWithQuality]" \
  --input-format SingleEndFastqManifestPhred33V2 \
  --input-path ./manifest_usa.tsv \
  --output-path ./demux_seqs.qza

# Convert the qza file to a qzv file
qiime demux summarize \
  --i-data demux_seqs.qza \
  --o-visualization demux_seqs.qzv

# Secure transfer qzv file to local computer
 scp root@10.19.139.184:/data/project_2/demux_seqs.qzv .

# Denoising data using DADA2
qiime dada2 denoise-single \
  --i-demultiplexed-seqs demux_seqs.qza \
  --p-trim-left 0 \
  --p-trunc-len 0 \
  --o-representative-sequences rep-seqs.qza \
  --o-table table.qza \
  --o-denoising-stats stats.qza

# Visualize ASVs stats
qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file /data/project_2/metadata_usa.tsv
  
qiime feature-table tabulate-seqs \
  --i-data rep-seqs.qza \
  --o-visualization rep-seqs.qzv

# Remove mitochondria and chloroplast sequences
qiime taxa filter-table \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-table table-no-mitochondria-no-chloroplast.qza

  qiime feature-table summarize \
  --i-table table-no-mitochondria-no-chloroplast.qza \
  --o-visualization table-no-mitochondria-no-chloroplast.qzv \
  --m-sample-metadata-file metadata_usa.tsv

# Filter out rare ASVs from filtered taxa table
qiime feature-table filter-features \
  --i-table table-no-mitochondria-no-chloroplast.qza \
  --p-min-frequency 5 \
  --o-filtered-table final-cleaned-table.qza

qiime feature-table summarize \
  --i-table final-cleaned-table.qza \
  --o-visualization final-cleaned-table.qzv \
  --m-sample-metadata-file metadata_usa.tsv

# Secure transfer to local server
scp -r root@10.19.139.184:/data/project_2/table.qzv .
scp -r root@10.19.139.184:/data/project_2/final-cleaned-table.qzv .


# Seccure transfer table.qzv file to local computer and view 
  scp -r root@10.19.139.184:/data/project_2/table.qzv .
